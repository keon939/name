<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - Classhelper</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard">
    <h1>Welcome to Classhelper</h1>
    <div class="post-box">
      <textarea id="postText" placeholder="What's on your mind?"></textarea>
      <button onclick="submitPost()">Post</button>
    </div>
    <div id="posts"></div>

    <h2>Direct Messages</h2>
    <select id="userList"></select>
    <input id="dmText" placeholder="Type message">
    <button onclick="sendDM()">Send</button>
    <div id="dmBox"></div>

    <h3>Data Usage</h3>
    <p id="dataInfo">Loading...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, set, update
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADgCrG3hspwEO45ARRkRdOh7j_vvOhouY",
      authDomain: "rufed-c71e5.firebaseapp.com",
      databaseURL: "https://rufed-c71e5-default-rtdb.firebaseio.com",
      projectId: "rufed-c71e5",
      storageBucket: "rufed-c71e5.appspot.com",
      messagingSenderId: "408519198212",
      appId: "1:408519198212:web:31e0e246307d8b24935751"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let currentUser;
    let userUID;

    onAuthStateChanged(auth, user => {
      if (!user) return;
      userUID = user.uid;
      currentUser = user;
      loadPosts();
      loadUsers();
      trackUsage();
    });

    function submitPost() {
      const text = document.getElementById("postText").value;
      if (text.trim() === "") return;
      const postRef = push(ref(db, "posts"));
      set(postRef, {
        uid: userUID,
        text,
        timestamp: Date.now()
      });
      document.getElementById("postText").value = "";
    }

    function loadPosts() {
      onValue(ref(db, "posts"), snapshot => {
        const postsDiv = document.getElementById("posts");
        postsDiv.innerHTML = "";
        snapshot.forEach(child => {
          const p = child.val();
          const div = document.createElement("div");
          div.className = "post";
          div.textContent = p.text;
          postsDiv.appendChild(div);
        });
      });
    }

    function loadUsers() {
      onValue(ref(db, "users"), snapshot => {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";
        snapshot.forEach(child => {
          const user = child.val();
          const opt = document.createElement("option");
          opt.value = child.key;
          opt.textContent = user.username;
          if (child.key !== userUID) userList.appendChild(opt);
        });
      });
    }

    function sendDM() {
      const targetUID = document.getElementById("userList").value;
      const text = document.getElementById("dmText").value;
      if (!targetUID || !text.trim()) return;
      const msgRef = push(ref(db, `dm/${userUID}_${targetUID}`));
      set(msgRef, {
        from: userUID,
        to: targetUID,
        text,
        time: Date.now()
      });
      document.getElementById("dmText").value = "";
      update(ref(db, `users/${userUID}`), { dataUsed: Date.now() % 1000 });
    }

    function trackUsage() {
      onValue(ref(db, `users/${userUID}/dataUsed`), snap => {
        const data = snap.val() || 0;
        const money = (data / 10).toFixed(2);
        document.getElementById("dataInfo").innerText = `You've used ${data} units = $${money}`;
      });
    }
  </script>
</body>
</html>
