<!DOCTYPE html>
<html>
<head>
  <title>Classhelper Login</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="login-box">
    <h2>Classhelper</h2>
    <form id="form">
      <input name="username" placeholder="Username (a_ for admin, m_ for moderator)" required>
      <input name="email" type="email" placeholder="Email" required>
      <input name="pass" type="password" placeholder="Password" required>
      <input name="passcode" placeholder="Passcode" required>
      <select name="mode">
        <option value="register">Register</option>
        <option value="login">Login</option>
      </select>
      <button type="submit">Go</button>
    </form>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getDatabase, ref, set, get, child
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADgCrG3hspwEO45ARRkRdOh7j_vvOhouY",
      authDomain: "rufed-c71e5.firebaseapp.com",
      databaseURL: "https://rufed-c71e5-default-rtdb.firebaseio.com",
      projectId: "rufed-c71e5",
      storageBucket: "rufed-c71e5.appspot.com",
      messagingSenderId: "408519198212",
      appId: "1:408519198212:web:31e0e246307d8b24935751"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const form = document.getElementById("form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = form.username.value.trim();
      const email = form.email.value;
      const password = form.pass.value;
      const passcode = form.passcode.value;
      const mode = form.mode.value;

      const isAdmin = username.startsWith("a_");
      const isMod = username.startsWith("m_");
      const role = isAdmin ? "admin" : isMod ? "moderator" : "student";

      if (mode === "register") {
        try {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          await set(ref(db, 'users/' + userCred.user.uid), {
            username,
            email,
            passcode,
            role,
            suspended: false,
            dataUsed: 0
          });
          alert("Registered!");
          window.location.href = role === "admin" ? "admin.html" : role === "moderator" ? "moderator.html" : "dashboard.html";
        } catch (err) {
          alert(err.message);
        }
      } else {
        try {
          const userCred = await signInWithEmailAndPassword(auth, email, password);
          const snapshot = await get(child(ref(db), 'users/' + userCred.user.uid));
          const user = snapshot.val();
          if (user.suspended) {
            alert("You are suspended.");
          } else {
            window.location.href = user.role === "admin" ? "admin.html" : user.role === "moderator" ? "moderator.html" : "dashboard.html";
          }
        } catch (err) {
          alert(err.message);
        }
      }
    });
  </script>
</body>
</html>
